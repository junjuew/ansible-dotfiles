---
# This playbook deploys the whole application stack in this site.

# need to install python 2 since ansible by default uses python2 as interpreter
# see: https://github.com/ansible/ansible/issues/17081
- hosts: all
  gather_facts: False 
  tasks:
  - name: install python 2 if not installed
    raw: test -e /usr/bin/python || (apt -y update && apt install -y python-minimal python-apt python-pip)
    become: true
  tags: must_run

- name: create a user
  hosts: all
  roles:
    - user
  tags: user_setup

- name: apply common configuration to all nodes
  hosts: all
  roles:
    - common

- name: deploying servers
  hosts: servers
  roles:
    - bash
    - fish
    - tmux

- name: apply basic, advanced, and gui to desktops
  hosts: desktops
  roles:
    - bash
    - fish
    - { role: tmux, tags: ['tmux'] }
    - gui

- name: install gpu drivers
  hosts: gpus
  vars:
    gpu: true
    cuda_packages:
      - cuda-9-0
  roles:
    - { role: CSCfi.cuda, become: true }
    - cudnn

- name: install packages needed for cv
  hosts: cv
  roles:
    - { role: conda, tags: ['conda'] }
    - { role: tensorflow-object-detection-api, tags: ['tensorflow'] }

- name: install packages needed for kvm-host
  hosts: kvm-host
  roles:
    - kvm

- name: install docker packages
  hosts: docker-host
  roles:
    - role: geerlingguy.docker
      vars: 
         docker_package: "docker-{{ docker_edition }}"
         docker_package_state: present

- name: install nvidia-docker
  hosts: nvidia-docker-host
  tasks:
    - include_role:
        name: nvidia-docker
      vars:
        nvidia_docker_version: '2.0'
      when: "ansible_distribution == 'Ubuntu'"