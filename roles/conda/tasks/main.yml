---
- name: check if miniconda dir exists
  stat:
    path: "{{ ansible_env.HOME }}/miniconda"
  register: miniconda_dir

- block:
  - name: download miniconda installation script
    get_url:
      url: 'https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh'
      dest: '/tmp/miniconda.sh'

  - name: run the installation script. Does not let the installer modify the bashrc and install miniconda to directory miniconda
    shell: 'bash /tmp/miniconda.sh -b -p ${HOME}/miniconda'

  - name: create bashrc_custom file if it do not exits
    copy:
      content: ""
      dest: '~/.bashrc_custom'
      force: no
      owner: '{{ ansible_env.USER }}'
      group: '{{ ansible_env.USER }}'
      mode: u=rw,g=r,o=r

  - name: add miniconda path to bashrc_custom
    blockinfile:
      path: "{{ ansible_env.HOME }}/.bashrc_custom"
      marker: "# {mark} ANSIBLE MANAGED BLOCK miniconda #"
      block: |
        . {{ ansible_env.HOME }}/miniconda/etc/profile.d/conda.sh
        conda activate

  - name: copy .condarc file
    copy:
      src: condarc
      dest: "{{ ansible_env.HOME}}/.condarc"
      backup: yes
  when: miniconda_dir.stat.exists == False

# config.fish already handles sourcing miniconda fish config file gracefully. No
# need to add it here